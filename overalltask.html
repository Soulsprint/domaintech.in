<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Task Management Dashboard</title>
    <link rel="stylesheet" href="overalltask.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">    
</head>
<body>
     <div class="menu-icon" onclick="toggleSidebar()"><i class="fas fa-bars" style="color: #a67c52;"></i></div>
    <div class="sidebar" id="sidebar">
        <a href="Apage1.html"><i class="fas fa-home" style="color: white;"></i> Home</a>
        <a href="sender.html"><i class="fas fa-tasks" style="color: white;"></i> Assign Task</a>
      <a href="overalltask.html"><i class="fas fa-project-diagram" style="color: white;"></i> Overall Task</a>
        <a href="Approvetask.html"><i class="fas fa-check-circle" style="color: white;"></i> Approve Task</a>
        <a href="table.html"><i class="fas fa-clipboard-check" style="color: white;"></i> Completed Tasks</a>
        <a href="Dashboard.html"><i class="fas fa-chart-line" style="color: white;"></i> Dashboard</a>




 
<!-- Option 3: Project diagram -->


   </div>
    <div class="dashboard">
        <div class="header">
            <h1>üéØ Task Management Dashboard</h1>
            <p>Click on tasks to view details ‚Ä¢ Drag and drop to reassign workload</p>
        </div>

        <div id="loading" class="loading">
            üîÑ Loading employee data...
        </div>

        <div id="error" class="error" style="display: none;">
            ‚ùå Failed to load data. Please check your connection and try again.
        </div>

        <div class="employees-grid" id="employeesGrid" style="display: none;">
            <!-- Employee cards will be generated by JavaScript -->
        </div>
    </div>

    <button class="refresh-btn" onclick="loadDashboard()" title="Refresh Data">
        üîÑ
    </button>

    <script>
        // API Configuration
        const API_BASE_URL = 'http://localhost:1080';
        
        // Employee configurations (timeline-based)
        const EMPLOYEES = [
            { id: 1, name: "Employee 1", avatar: "E1", department: "Team Alpha" },
            { id: 2, name: "Employee 2", avatar: "E2", department: "Team Beta" },
            { id: 3, name: "Employee 3", avatar: "E3", department: "Team Gamma" },
            { id: 4, name: "Employee 4", avatar: "E4", department: "Team Delta" },
            { id: 5, name: "Employee 5", avatar: "E5", department: "Team Epsilon" },
            { id: 6, name: "Employee 6", avatar: "E6", department: "Team Zeta" },
            { id: 7, name: "Employee 7", avatar: "E7", department: "Team Eta" },
            { id: 8, name: "Employee 8", avatar: "E8", department: "Team Theta" }
        ];

        let employeesData = [];

        // API Functions
        async function fetchTasksForEmployee(timeline) {
            try {
                const response = await fetch(`${API_BASE_URL}/tasks/${timeline}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error(`Error fetching tasks for employee ${timeline}:`, error);
                return [];
            }
        }

        async function updateTaskTimeline(taskId, newTimeline) {
            try {
                const response = await fetch(`${API_BASE_URL}/update-timeline`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        task_id: taskId,
                        timeline: newTimeline
                    })
                });

                if (!response.ok) {
                    const errText = await response.text();
                    throw new Error(`HTTP error! ${errText}`);
                }

                return await response.json();
            } catch (error) {
                console.error('üî• Error updating timeline:', error);
                throw error;
            }
        }

        // Load dashboard data
        async function loadDashboard() {
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const gridEl = document.getElementById('employeesGrid');

            try {
                loadingEl.style.display = 'block';
                errorEl.style.display = 'none';
                gridEl.style.display = 'none';

                // Fetch tasks for all employees
                const employeePromises = EMPLOYEES.map(async (employee) => {
                    const tasks = await fetchTasksForEmployee(employee.id);
                    return {
                        ...employee,
                        tasks: tasks || []
                    };
                });

                employeesData = await Promise.all(employeePromises);
                renderEmployees();

                loadingEl.style.display = 'none';
                gridEl.style.display = 'grid';

            } catch (error) {
                console.error('Error loading dashboard:', error);
                loadingEl.style.display = 'none';
                errorEl.style.display = 'block';
            }
        }

        // Calculate task completion percentage
        function calculateProgress(tasks) {
            if (tasks.length === 0) return 0;
            return Math.min(tasks.length * 10, 100);
        }

        // Format date for display
        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric',
                    year: 'numeric'
                });
            } catch (error) {
                return dateString;
            }
        }

        // Format datetime for display (includes time)
        function formatDateTime(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                return date.toLocaleString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                });
            } catch (error) {
                return dateString;
            }
        }

        // Format time ago (relative time)
        function formatTimeAgo(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                const now = new Date();
                const diffInSeconds = Math.floor((now - date) / 1000);
                
                if (diffInSeconds < 60) return 'Just now';
                if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
                if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
                if (diffInSeconds < 2592000) return `${Math.floor(diffInSeconds / 86400)}d ago`;
                if (diffInSeconds < 31536000) return `${Math.floor(diffInSeconds / 2592000)}mo ago`;
                return `${Math.floor(diffInSeconds / 31536000)}y ago`;
            } catch (error) {
                return dateString;
            }
        }

        // Generate task item HTML with collapsible details
        function generateTaskItem(task, employeeId) {
    const dueDate = formatDate(task.due_date || task.dueDate);
    const createdAt = formatDateTime(task.created_at);
    const timeAgo = formatTimeAgo(task.created_at);
    const hasDetails = task.description || task.details || task.content || task.problem_reported || 
                      task.status || dueDate || createdAt || task.accessories;

    return `
        <div class="task-item ${task.response ? 'has-response' : ''}" draggable="true" data-task-id="${task.id}" data-employee-id="${employeeId}">
            <div class="task-name">
                <span>${task.name || task.title || 'Untitled Task'}</span>
                ${task.response ? '<span class="red-dot" title="Condition added"></span>' : ''}
                ${hasDetails ? '<span class="expand-indicator">‚ñº</span>' : ''}
            </div>

            <div class="task-basic-info">
                <span class="task-number">#${task.number || task.id}</span>
                <span class="task-timeline">EMP ID: ${task.timeline}</span>
            </div>

            ${hasDetails ? `
                <div class="task-details">
                    ${task.description || task.details || task.content || task.problem_reported ? `
                        <div class="task-description">
                            ${task.description || task.details || task.content || task.problem_reported}
                        </div>
                    ` : ''}

                    <div class="task-meta">
                        ${task.accessories ? `<span class="task-accessories">Accessories: ${task.accessories}</span>` : ''}
                        ${createdAt ? `<span class="task-created">Created: ${createdAt}</span>` : ''}
                        ${timeAgo ? `<span class="task-time-ago">${timeAgo}</span>` : ''}
                        ${dueDate ? `<span class="task-due-date">Due: ${dueDate}</span>` : ''}
                        ${task.status ? `<span class="task-status">Status: ${task.status}</span>` : ''}
                        ${task.assignedTo ? `<span class="task-assigned">Assigned: ${task.assignedTo}</span>` : ''}
                        ${task.response ? `<span class="task-response">Condition: ${task.response}</span>` : ''}
                        ${task.category ? `<span class="task-category">Category: ${task.category}</span>` : ''}
                        ${task.project ? `<span class="task-project">Project: ${task.project}</span>` : ''}
                        ${task.priority ? `<span class="task-priority">Priority: ${task.priority}</span>` : ''}
                    </div>
                </div>
            ` : ''}
        </div>
    `;
}
        // Generate employee card HTML
        function generateEmployeeCard(employee) {
            const progressPercentage = calculateProgress(employee.tasks);
            
            return `
                <div class="employee-card" data-employee-id="${employee.id}">
                    <div class="employee-header">
                        <div class="employee-avatar">${employee.avatar}</div>
                        <div class="employee-info">
                            <h3>${employee.name}</h3>
                            <p>${employee.department}</p>
                        </div>
                    </div>
                    
                    <div class="progress-section">
                        <div class="progress-header">
                            <h4>Active Tasks</h4>
                            <span class="task-count">${employee.tasks.length} tasks</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progressPercentage}%"></div>
                        </div>
                        <div class="progress-text">Total: ${employee.tasks.length} tasks</div>
                    </div>
                    
                    <div class="tasks-container">
                        ${employee.tasks.length > 0 ? 
                            employee.tasks.map(task => generateTaskItem(task, employee.id)).join('') : 
                            '<div class="empty-state">No tasks assigned</div>'
                        }
                    </div>
                </div>
            `;
        }

        // Render all employee cards
        function renderEmployees() {
            const grid = document.getElementById('employeesGrid');
            grid.innerHTML = employeesData.map(employee => generateEmployeeCard(employee)).join('');
            setupDragAndDrop();
            setupTaskToggle();
        }

        // Setup task click toggle functionality
        function setupTaskToggle() {
            const taskItems = document.querySelectorAll('.task-item');
            
            taskItems.forEach(task => {
                task.addEventListener('click', function(e) {
                    // Prevent toggle during drag operations
                    if (this.classList.contains('dragging')) return;
                    
                    const details = this.querySelector('.task-details');
                    if (details) {
                        this.classList.toggle('expanded');
                        details.classList.toggle('show');
                    }
                });
            });
        }

        // Setup drag and drop functionality
        function setupDragAndDrop() {
            const taskItems = document.querySelectorAll('.task-item');
            const employeeCards = document.querySelectorAll('.employee-card');

            // Add drag event listeners to tasks
            taskItems.forEach(task => {
                task.addEventListener('dragstart', handleDragStart);
                task.addEventListener('dragend', handleDragEnd);
            });

            // Add drop event listeners to employee cards
            employeeCards.forEach(card => {
                card.addEventListener('dragover', handleDragOver);
                card.addEventListener('dragenter', handleDragEnter);
                card.addEventListener('dragleave', handleDragLeave);
                card.addEventListener('drop', handleDrop);
            });
        }

        let draggedTask = null;

        function handleDragStart(e) {
            draggedTask = {
                taskId: parseInt(e.target.dataset.taskId),
                fromEmployeeId: parseInt(e.target.dataset.employeeId)
            };
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            document.querySelectorAll('.employee-card').forEach(card => {
                card.classList.remove('drag-over');
            });
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleDragEnter(e) {
            e.preventDefault();
            const card = e.currentTarget;
            const targetEmployeeId = parseInt(card.dataset.employeeId);
            
            if (draggedTask && draggedTask.fromEmployeeId !== targetEmployeeId) {
                card.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            const card = e.currentTarget;
            const rect = card.getBoundingClientRect();
            const x = e.clientX;
            const y = e.clientY;
            
            if (x < rect.left || x > rect.right || y < rect.top || y > rect.bottom) {
                card.classList.remove('drag-over');
            }
        }

        async function handleDrop(e) {
            e.preventDefault();
            const card = e.currentTarget;
            const targetEmployeeId = parseInt(card.dataset.employeeId);
            
            card.classList.remove('drag-over');
            
            if (draggedTask && draggedTask.fromEmployeeId !== targetEmployeeId) {
                try {
                    await moveTask(draggedTask.taskId, draggedTask.fromEmployeeId, targetEmployeeId);
                } catch (error) {
                    showNotification('‚ùå Failed to move task. Please try again.', 'error');
                }
            }
            
            draggedTask = null;
        }

        // Move task from one employee to another
        async function moveTask(taskId, fromEmployeeId, toEmployeeId) {
            try {
                showNotification('üîÑ Moving task...', 'info');

                // Update in database
                await updateTaskTimeline(taskId, toEmployeeId);

                const fromEmployee = employeesData.find(emp => emp.id === fromEmployeeId);
                const toEmployee = employeesData.find(emp => emp.id === toEmployeeId);

                if (fromEmployee && toEmployee) {
                    const taskIndex = fromEmployee.tasks.findIndex(task => task.id === taskId);
                    if (taskIndex !== -1) {
                        const task = fromEmployee.tasks.splice(taskIndex, 1)[0];
                        task.timeline = toEmployeeId;
                        toEmployee.tasks.push(task);

                        showNotification(`‚úÖ Task "${task.name || task.title || 'Task'}" moved from ${fromEmployee.name} to ${toEmployee.name}`, 'success');

                        renderEmployees();
                    }
                }
            } catch (error) {
                console.error('Error moving task:', error);
                showNotification('‚ùå Failed to move task. Please try again.', 'error');
            }
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            const bgColor = type === 'error' ? '#bf360c' : type === 'info' ? '#1565c0' : '#2e7d32';
            
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${bgColor};
                color: #efebe9;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.4);
                z-index: 10000;
                animation: slideIn 0.3s ease;
                max-width: 300px;
                border: 1px solid rgba(239, 235, 233, 0.2);
            `;
            notification.textContent = message;
            
            // Add animation keyframes if not already added
            if (!document.querySelector('#notification-styles')) {
                const style = document.createElement('style');
                style.id = 'notification-styles';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Initialize the dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            loadDashboard();
        });

        // Add this JavaScript function to your existing script section
// Add this function to your existing script section
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    sidebar.classList.toggle('active');
}

// Optional: Close sidebar when clicking outside
document.addEventListener('click', function(event) {
    const sidebar = document.getElementById('sidebar');
    const menuIcon = document.querySelector('.menu-icon');
    
    if (!sidebar.contains(event.target) && !menuIcon.contains(event.target)) {
        sidebar.classList.remove('active');
    }
});
    </script>
</body>
</html>